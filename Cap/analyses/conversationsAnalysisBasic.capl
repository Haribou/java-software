# A simple realtime conversational analysis for all conversations in a time window, plus histograms for conversation numbers and trouble scores for all of history.

settings:

debug: false,
recording: false,
expires: 30 * 24 * 60;

constants:

WINDOW_LENGTH_MINUTES: 15,
TROUBLE_SCORE_HISTO_BUCKET_WIDTH: 0.1,
TROUBLE_SCORE_HISTO_BUCKETS: 1 // TROUBLE_SCORE_HISTO_BUCKET_WIDTH,
WEBHOOK_URL1: "https://webhook.site/c9783647-e407-4dec-af61-c98afdc251fe";

variables:

troubleScoresInTimeWindow: list{ WINDOW_LENGTH_MINUTES },
conversationsInTimeWindow: set{ WINDOW_LENGTH_MINUTES },
postPayload: map[]("analysisId": "conversationsAnalysis", "vaId": @["analysis"]["vaId"], "label": "Trouble Score Live Tracker");

updateRules:

:
	:
		conversationsInTimeWindow add(@["analysis"]["sessionId"]),
		
:
	:
		troubleScoresInTimeWindow add(@["analysis"]["troubleScore"]),
		
:
	:
		postPayload add("timestamp": now,
						"avgTroubleScore": troubleScoresInTimeWindow avg, 
						"maxTroubleScore": troubleScoresInTimeWindow max, 
						"stdDevTroubleScore": troubleScoresInTimeWindow stdDev, 
						"numConversationsInTimeWindow": conversationsInTimeWindow count,
						"troubleScoresHistogram": troubleScoresInTimeWindow histo(0, TROUBLE_SCORE_HISTO_BUCKETS, TROUBLE_SCORE_HISTO_BUCKET_WIDTH));
						
outputRules:

:
	:								
		post(WEBHOOK_URL1, "", postPayload);